/*! rasterizeHTML.js - v0.9.1 - 2014-06-22
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2014 Christoph Burgmer; Licensed MIT */
!function(a,b){"object"==typeof exports?module.exports=b(require("url"),require("xmlserializer"),require("ayepromise"),require("inlineresources")):"function"==typeof define&&define.amd?define(["url","xmlserializer","ayepromise","inlineresources"],b):a.rasterizeHTML=b(a.url,a.xmlserializer,a.ayepromise,a.inlineresources)}(this,function(a,b,c,d){var e=function(a){"use strict";var b={},c=[];b.joinUrl=function(b,c){return b?a.resolve(b,c):c},b.getConstantUniqueIdFor=function(a){return c.indexOf(a)<0&&c.push(a),c.indexOf(a)},b.clone=function(a){var b,c={};for(b in a)a.hasOwnProperty(b)&&(c[b]=a[b]);return c};var d=function(a){return"object"==typeof a&&null!==a},e=function(a){return d(a)&&Object.prototype.toString.apply(a).match(/\[object (Canvas|HTMLCanvasElement)\]/i)},f=function(a){return"function"==typeof a};return b.parseOptionalParameters=function(a){var c={canvas:null,options:{},callback:null};return f(a[0])?c.callback=a[0]:null==a[0]||e(a[0])?(c.canvas=a[0]||null,f(a[1])?c.callback=a[1]:(c.options=b.clone(a[1]),c.callback=a[2]||null)):(c.options=b.clone(a[0]),c.callback=a[1]||null),c},b}(a),f=function(a,b){var c={};return c.baseUrlRespecting=function(b,c){var d=function(){var d=new b,e=d.open;return d.open=function(){var b=Array.prototype.slice.call(arguments),d=b.shift(),f=b.shift(),g=a.joinUrl(c,f);return e.apply(this,[d,g].concat(b))},d};return d},c.finishNotifying=function(a){var c=0,d=0,e=!1,f=b.defer(),g=function(){var a=c-d;0>=a&&e&&f.resolve({totalCount:c})},h=function(){var b=new a,e=b.send;return b.send=function(){return c+=1,e.apply(this,arguments)},b.addEventListener("load",function(){d+=1,g()}),b};return h.waitForRequestsToFinish=function(){return e=!0,g(),f.promise},h},c}(e,c),g=function(){"use strict";var a={},b=function(a){return Array.prototype.slice.call(a)};a.addClassNameRecursively=function(b,c){b.className+=" "+c,b.parentNode!==b.ownerDocument&&a.addClassNameRecursively(b.parentNode,c)};var c=function(a,c){var d=a.parentStyleSheet,e=b(d.cssRules).indexOf(a);d.insertRule(c,e+1),d.deleteRule(e)},d=function(a,b){var d=a.cssText.replace(/^[^\{]+/,""),e=b+" "+d;c(a,e)},e=function(a){return b(a).reduce(function(a,b){return a+b.cssText},"")},f=function(a){a.textContent=e(a.sheet.cssRules)};return a.rewriteStyleRuleSelector=function(a,c,e){var g=c+"(?=\\W|$)";b(a.querySelectorAll("style")).forEach(function(a){var c=b(a.sheet.cssRules).filter(function(a){return a.selectorText&&new RegExp(g).test(a.selectorText)});c.length&&(c.forEach(function(a){var b=a.selectorText.replace(new RegExp(g,"g"),e);d(a,b)}),f(a))})},a}(),h=function(a){"use strict";var b={},c=function(a){return Array.prototype.slice.call(a)};return b.fakeHover=function(b,c){var d=b.querySelector(c),e="rasterizehtmlhover";d&&(a.addClassNameRecursively(d,e),a.rewriteStyleRuleSelector(b,":hover","."+e))},b.fakeActive=function(b,c){var d=b.querySelector(c),e="rasterizehtmlactive";d&&(a.addClassNameRecursively(d,e),a.rewriteStyleRuleSelector(b,":active","."+e))},b.persistInputValues=function(a){var b=a.querySelectorAll("input"),d=a.querySelectorAll("textarea"),e=function(a){return"checkbox"===a.type||"radio"===a.type};c(b).filter(e).forEach(function(a){a.checked?a.setAttribute("checked",""):a.removeAttribute("checked")}),c(b).filter(function(a){return!e(a)}).forEach(function(a){a.setAttribute("value",a.value)}),c(d).forEach(function(a){a.textContent=a.value})},b}(g),i=function(a,b,c,d){"use strict";var e={},f=function(a,b){var c=a.createElement(b);return c.style.visibility="hidden",c.style.width="0px",c.style.height="0px",c.style.position="absolute",c.style.top="-10000px",c.style.left="-10000px",a.getElementsByTagName("body")[0].appendChild(c),c};e.executeJavascript=function(a,e,g){var h=f(d.document,"iframe"),i=a.documentElement.outerHTML,j=[],k=c.defer(),l=function(){var a=h.contentDocument;d.document.getElementsByTagName("body")[0].removeChild(h),k.resolve({document:a,errors:j})},m=function(){var a=c.defer();return g>0?setTimeout(a.resolve,g):a.resolve(),a.promise};h.onload=function(){m().then(o.waitForRequestsToFinish).then(l)};var n=h.contentWindow.XMLHttpRequest,o=b.finishNotifying(n),p=b.baseUrlRespecting(o,e);return h.contentDocument.open(),h.contentWindow.XMLHttpRequest=p,h.contentWindow.onerror=function(a){j.push({resourceType:"scriptExecution",msg:a})},h.contentDocument.write(i),h.contentDocument.close(),k.promise};var g=function(a,b,c){var d=a.createElement("iframe");return d.style.width=b+"px",d.style.height=c+"px",d.style.visibility="hidden",d.style.position="absolute",d.style.top=-1e4-c+"px",d.style.left=-1e4-b+"px",d.sandbox="allow-same-origin",d},h=function(a,b){var c=Math.floor(a.width/b),e=Math.floor(a.height/b);return g(d.document,c,e)},i=function(a,b,c){return{width:Math.max(a.width*c,b.width),height:Math.max(a.height*c,b.height)}},j=function(a,b,c,d){var e,f,g,h,j,k,l,m=Math.max(a.documentElement.scrollWidth,a.body.clientWidth),n=Math.max(a.documentElement.scrollHeight,a.body.scrollHeight,a.body.clientHeight);if(b){if(j=a.querySelector(b),!j)throw{message:"Clipping selector not found"};k=j.getBoundingClientRect(),e=k.top,f=k.left,g=k.width,h=k.height}else e=0,f=0,g=m,h=n;return l=i({width:g,height:h},c,d),{left:f,top:e,width:l.width,height:l.height,viewportWidth:m,viewportHeight:n}};e.calculateDocumentContentSize=function(a,b,e){var f,g=a.documentElement.outerHTML,i=c.defer(),k=e.zoom||1;return f=h(b,k),d.document.getElementsByTagName("body")[0].appendChild(f),f.onload=function(){var a,c=f.contentDocument;try{a=j(c,e.clip,b,k),d.document.getElementsByTagName("body")[0].removeChild(f),i.resolve(a)}catch(g){i.reject(g)}},f.contentDocument.open(),f.contentDocument.write(g),f.contentDocument.close(),i.promise};var k=function(a,b){var c,e,f,g,h=/<html((?:\s+[^>]*)?)>/im.exec(b),i=d.document.implementation.createHTMLDocument("");if(h)for(c="<div"+h[1]+"></div>",i.documentElement.innerHTML=c,f=i.querySelector("div"),e=0;e<f.attributes.length;e++)g=f.attributes[e],a.documentElement.setAttribute(g.name,g.value)};e.parseHTML=function(a){var b;return(new DOMParser).parseFromString("<a></a>","text/html")?b=(new DOMParser).parseFromString(a,"text/html"):(b=d.document.implementation.createHTMLDocument(""),b.documentElement.innerHTML=a,k(b,a)),b};var l=function(a){var b=new DOMParser,c=b.parseFromString("<","text/xml"),d=c.getElementsByTagName("parsererror")[0].namespaceURI;return"http://www.w3.org/1999/xhtml"===d?a.getElementsByTagName("parsererror").length>0:a.getElementsByTagNameNS(d,"parsererror").length>0},m=function(a){if(l(a))throw{message:"Invalid source"}};e.validateXHTML=function(a){var b=new DOMParser,c=b.parseFromString(a,"application/xml");m(c)};var n=null,o=function(a,b){return b===!1||"none"===b||"repeated"===b?((null===n||"repeated"!==b)&&(n=Date.now()),a+"?_="+n):a},p=function(b,d){var e=new window.XMLHttpRequest,f=a.joinUrl(d.baseUrl,b),g=o(f,d.cache),h=c.defer(),i=function(){h.reject({message:"Unable to load page"})};e.addEventListener("load",function(){200===e.status||0===e.status?h.resolve(e.responseXML):i()},!1),e.addEventListener("error",function(){i()},!1);try{e.open("GET",g,!0),e.responseType="document",e.send(null)}catch(j){i()}return h.promise};return e.loadDocument=function(a,b){return p(a,b).then(function(a){return m(a),a})},e}(e,f,c,window),j=function(a,b,c,d,e,f){"use strict";var g={},h=function(){if(f.navigator.userAgent.indexOf("WebKit")>=0&&f.navigator.userAgent.indexOf("Chrome")<0)return!1;if(f.BlobBuilder||f.MozBlobBuilder||f.WebKitBlobBuilder)return!0;if(f.Blob)try{return new f.Blob(["<b></b>"],{type:"text/xml"}),!0}catch(a){return!1}return!1},i=function(a){var b,c="image/svg+xml;charset=utf-8",d=f.BlobBuilder||f.MozBlobBuilder||f.WebKitBlobBuilder;return d?(b=new d,b.append(a),b.getBlob(c)):new f.Blob([a],{type:c})},j=function(a){var b=f.URL||f.webkitURL||f;return h()?b.createObjectURL(i(a)):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(a)},k=function(a){var b=f.URL||f.webkitURL||f;h()&&b.revokeObjectURL(a)},l=function(a,b){var c,d,e,f;b=b||1,c=Math.round(a.viewportWidth),d=Math.round(a.viewportHeight),e=-a.left,f=-a.top;var g={x:e,y:f,width:c,height:d};return 1!==b&&(g.style="-webkit-transform: scale("+b+"); -webkit-transform-origin: 0 0; transform: scale("+b+"); transform-origin: 0 0;"),g},m=function(a){var b=a.style||"";a.style=b+"float: left;"},n=function(a){var b=Object.keys(a);return b.length?" "+b.map(function(b){return b+'="'+a[b]+'"'}).join(" "):""};g.getSvgForDocument=function(a,c,e){var f;f=d.serializeToString(a),b.validateXHTML(f);var g=l(c,e);return m(g),'<svg xmlns="http://www.w3.org/2000/svg" width="'+c.width+'" height="'+c.height+'"><foreignObject'+n(g)+">"+f+"</foreignObject></svg>"};var o=function(){return{message:"Error rendering page"}};g.renderSvg=function(a){var b,c,d=e.defer(),g=function(){c.onload=null,c.onerror=null},h=function(){b&&k(b)};return b=j(a),c=new f.Image,c.onload=function(){g(),h(),d.resolve(c)},c.onerror=function(){h(),d.reject(o())},c.src=b,d.promise},g.drawImageOnCanvas=function(a,b){try{b.getContext("2d").drawImage(a,0,0)}catch(c){throw o()}};var p=function(a,b){var c=300,d=200,e=a?a.width:c,f=a?a.height:d,g=void 0!==b.width?b.width:e,h=void 0!==b.height?b.height:f;return{width:g,height:h}};return g.drawDocumentImage=function(a,d,e){var f=p(d,e);return e.hover&&c.fakeHover(a,e.hover),e.active&&c.fakeActive(a,e.active),b.calculateDocumentContentSize(a,f,e).then(function(b){return g.getSvgForDocument(a,b,e.zoom)}).then(function(a){return g.renderSvg(a)})},g}(e,i,h,b,c,window),k=function(a,b,c,d,e){"use strict";var f={},g=function(a,b,c){return d.drawDocumentImage(a,b,c).then(function(a){return b&&d.drawImageOnCanvas(a,b),a})},h=function(a,d){var e=d.executeJsTimeout||0;return b.executeJavascript(a,d.baseUrl,e).then(function(a){var b=a.document;return c.persistInputValues(b),{document:b,errors:a.errors}})},i=function(b,c,d){var f;return f=a.clone(d),f.inlineScripts=d.executeJs===!0,e.inlineReferences(b,f).then(function(a){return d.executeJs?h(b,d).then(function(b){return{document:b.document,errors:a.concat(b.errors)}}):{document:b,errors:a}}).then(function(a){return g(a.document,c,d).then(function(b){return{image:b,errors:a.errors}})})};f.drawDocument=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c),e=i(b,d.canvas,d.options);return d.callback&&e.then(function(a){d.callback(a.image,a.errors)},function(){d.callback(null,[{resourceType:"document",msg:"Error rendering page"}])}),e};var j=function(a,c,d,e){var g=b.parseHTML(a);return f.drawDocument(g,c,d,e)};f.drawHTML=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return j(b,d.canvas,d.options,d.callback)};var k=function(b,c,d){var e=document.implementation.createHTMLDocument("");e.replaceChild(b.documentElement,e.documentElement);var f=d?a.clone(d):{};return d.baseUrl||(f.baseUrl=c),{document:e,options:f}},l=function(a,c,d,e){var g=b.loadDocument(a,d).then(function(b){var e=k(b,a,d);return f.drawDocument(e.document,c,e.options)});return e&&g.then(function(a){e(a.image,a.errors)},function(b){e(null,[{resourceType:"page",url:a,msg:b.message+" "+a}])}),g};return f.drawURL=function(){var b=arguments[0],c=Array.prototype.slice.call(arguments,1),d=a.parseOptionalParameters(c);return l(b,d.canvas,d.options,d.callback)},f}(e,i,h,j,d);return k});